# ТЕХНИЧЕСКОЕ ЗАДАНИЕ  
**Проект:** Интерактивная платформа для общения с ИИ-персонажами  
**Версия:** 2.0 (финальная)  
**Домен:** chat.mehhost.ru  
**Основная ИИ модель:** https://huggingface.co/Qwen/Qwen3-8B-GGUF/tree/main 
---

## 1. ОБЩИЕ ПОЛОЖЕНИЯ

### 1.1. Цель проекта
Создание веб-платформы для интерактивного общения с уникальными ИИ-персонажами в формате чат-бота с модульной архитектурой, обеспечивающей безопасность, отказоустойчивость и соответствие требованиям российской инфраструктуры без использования зарубежных CDN.

### 1.2. Основные принципы
- **Безопасность:** Многоуровневая защита данных и соединений
- **Отказоустойчивость:** Автоматическое восстановление при обрывах соединений
- **Производительность:** Оптимизация под доступные ресурсы (VDS 12 ГБ ОЗУ + локальный ПК)
- **Соблюдение законодательства:** Соответствие требованиям РФ в области персональных данных и ИИ-генерируемого контента
- **Модульность:** Независимая разработка и развертывание компонентов
- **Уникальность:** Каждый ИИ-персонаж имеет уникальную конфигурацию и поведение

### 1.3. Целевая аудитория
- **Конечные пользователи:** Люди, желающие общаться с ИИ-персонажами
- **Менеджеры:** Сотрудники, создающие и редактирующие ИИ-персонажей
- **Администраторы:** Технические специалисты, управляющие платформой
- **Модераторы:** Сотрудники, контролирующие контент и поведение персонажей

---

## 2. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 2.1. Система аутентификации и авторизации
- **Регистрация пользователей:**
  - Валидация email через SMTP-сервер собственной разработки
  - Подтверждение email с таймером повторной отправки
  - Хеширование паролей с использованием bcrypt
  
- **Авторизация:**
  - JWT токены с разделением на access и refresh токены
  - Хранение refresh токенов в HTTP-only cookies
  - Автоматическое обновление токенов при истечении срока
  
- **Ролевая модель (RBAC):**
  | Роль | Права |
  |------|-------|
  | Пользователь | Чат с персонажами, просмотр своего профиля, избранные сообщения |
  | Менеджер | Просмотр всех профилей, управление ИИ-персонажами (CRUD), тестирование |
  | Администратор | Полный доступ ко всем функциям, управление пользователями, мониторинг системы |
  | Модератор | Просмотр и модерация контента, блокировка пользователей, отчеты |

### 2.2. Чат-функционал

#### 2.2.1. Основные возможности
- **Реальное время общения:**
  - WebSocket соединение для мгновенного обмена сообщениями
  - Отображение статуса "печатает..." от ИИ-персонажа
  - Временные метки для каждого сообщения с точностью до секунды
  - Индикация доставки и прочтения сообщений

- **Управление контекстом:**
  - **Максимальное количество сообщений в активном контексте:** 20 сообщений
  - Автоматическое сжатие контекста при превышении лимита с сохранением ключевых смысловых единиц
  - Ручная очистка контекста кнопкой "Начать новый диалог"
  - Хранение полной истории всех сообщений в базе данных
  
- **Ограничение длины сообщений:**
  | Тип сообщения | Максимальная длина | Действие при превышении |
  |---------------|-------------------|------------------------|
  | Пользовательское | 1000 символов | Автоматическое обрезание с сохранением последних 100 символов |
  | От ИИ-персонажа | 2000 символов | Обрезание с добавлением "[...]" в конце |

#### 2.2.2. Расширенные функции чата
- **Избранные сообщения:**
  - Возможность пометить сообщение как "избранное"
  - Хранение до 50 избранных сообщений на пользователя
  - Группировка избранных сообщений по персонажам и датам
  
- **Кросс-платформенные сессии:**
  - Единый идентификатор сессии пользователя во всех устройствах
  - Синхронизация истории чатов в реальном времени при подключении нового устройства
  - Максимум 5 активных устройств на пользователя
  - Автоматический выход из неактивных сессий

### 2.3. Управление ИИ-персонажами

#### 2.3.1. Уникальность персонажей
- **Требования к уникальности:**
  - Каждый ИИ-персонаж должен иметь уникальную системную конфигурацию
  - Запрет на создание персонажей с идентичными системными промптами
  - Семантическая проверка сходства конфигураций

#### 2.3.2. Визуальный редактор персонажей (фронтенд)
- **Основные параметры:**
  - Имя персонажа (валидация: 2-50 символов, уникальность)
  - Описание персонажа (до 500 символов)
  - Системный промпт (до 2000 символов)
  - Температура генерации (слайдер 0.0-2.0)
  - Максимальная длина ответа (слайдер 100-2000 токенов)
  
- **Продвинутые настройки:**
  - Примеры диалогов (до 5 примеров)
  - Фильтры контента (включение/выключение тем)
  - Аватар персонажа (загрузка изображения до 2МБ)

### 2.4. Панели управления

#### 2.4.1. Админ-панель
- **Мониторинг системы:**
  - Dashboard с ключевыми метриками: количество активных пользователей, загрузка CPU/RAM
  - Графики производительности в реальном времени
  - Алертинг при превышении пороговых значений
  
- **Управление пользователями:**
  - Просмотр и поиск пользователей
  - Смена ролей и блокировка аккаунтов
  - Просмотр активности пользователей
  
- **Настройки системы:**
  - Конфигурация SMTP-сервера
  - Настройка параметров безопасности
  - Управление резервными копиями

#### 2.4.2. Профили пользователей
- **Отображение статуса сервиса:**
  - **Для администраторов и модераторов:** Виджет "Статус ИИ-сервиса" в профиле
    - Онлайн: Зеленый индикатор, текст "Сервис ИИ доступен"
    - Офлайн: Красный индикатор, текст "Сервис ИИ недоступен"
    - Перегрузка: Желтый индикатор, текст "Сервис ИИ перегружен"
  - **Для менеджеров:** Базовый индикатор онлайн/офлайн
  - **Для пользователей:** Статус не отображается

### 2.5. Система логирования и мониторинга
- **Типы логов:**
  | Категория | Уровень важности | Срок хранения |
  |-----------|-----------------|--------------|
  | Безопасность | Критический | 90 дней |
  | Бизнес-логика | Высокий | 30 дней |
  | Системные | Средний | 7 дней |
  
- **Мониторинг ресурсов:**
  - **Локальный ПК (ИИ-вычисления):**
    - Динамические круговые графики для CPU, GPU, RAM, отклика ИИ
    - Обновление данных: каждые 5 секунд
    - Цветовая индикация загрузки (зеленый/желтый/красный)
  
  - **VDS сервер (без GPU):**
    - Динамические круговые графики для CPU, RAM, диска, сети
    - Обновление данных: каждые 10 секунд
    - Учет отсутствия видеокарты на VDS

- **Система уведомлений:**
  - **Пороговые значения для алертов:**
    | Ресурс | Предупреждение | Критическое |
    |--------|---------------|-------------|
    | CPU (ПК) | > 80% | > 95% |
    | GPU (ПК) | > 85% | > 98% |
    | RAM (ПК) | > 25 ГБ | > 30 ГБ |
    | CPU (VDS) | > 75% | > 90% |
    | RAM (VDS) | > 9 ГБ | > 11 ГБ |
  
  - **Уведомления разработчику:**
    - Настройка почты разработчика при первоначальной конфигурации
    - Отправка email при превышении критических порогов
    - Ежедневные отчеты о производительности системы
    - Интеграция через SMTP сервер на VDS

### 2.6. Система мониторинга ресурсов и анализа запросов

#### 2.6.1. Предобученная ИИ-модель для анализа ресурсов
- **Назначение системы:**
  - Автоматический анализ использования ресурсов (CPU, RAM, GPU, сеть) для прогнозирования нагрузки
  - Обнаружение аномалий в паттернах запросов к ИИ-сервису
  - Генерация интеллектуальных отчетов для упрощения диагностики ошибок
  - Прогнозирование потенциальных сбоев на основе исторических данных

- **Требования к модели:**
  - **Легковесность:** Максимальный размер модели - 400 МБ в 4-битной квантованной версии
  - **Аппаратные требования:** Возможность запуска на VDS без GPU (потребление RAM ≤ 2 ГБ)
  - **Производительность:** Время анализа метрик за 1 час - ≤ 1.5 секунды
  - **Точность прогнозирования:** Средняя абсолютная ошибка (MAE) ≤ 8% для прогнозирования нагрузки

- **Функциональные возможности:**
  - **Анализ использования ресурсов:**
    - Прогнозирование пиковой нагрузки на CPU/RAM/GPU на следующие 24 часа
    - Обнаружение аномальных всплесков использования ресурсов
    - Корреляционный анализ между типами запросов и потреблением ресурсов
    - Выявление утечек памяти и неоптимального использования ресурсов
    
  - **Анализ запросов:**
    - Классификация типов запросов по интенсивности использования ресурсов
    - Обнаружение DDoS-подобных атак и аномальных паттернов запросов
    - Анализ распределения нагрузки по времени суток и дням недели
    - Определение "тяжелых" запросов, требующих оптимизации
    
  - **Генерация отчетов:**
    - Автоматическое формирование ежедневных/еженедельных отчетов по использованию ресурсов
    - Интеллектуальные рекомендации по оптимизации производительности
    - Корреляция ошибок с пиковыми нагрузками и внешними факторами
    - Предиктивные алерты о потенциальных проблемах за 30-60 минут до возникновения

#### 2.6.2. Интеграция с системой мониторинга
- **Автоматические действия:**
  | Уровень аномалии | Действие системы | Уведомление |
  |------------------|------------------|-------------|
  | Низкий (потенциальная проблема) | Логирование в отдельный канал | Email разработчику раз в сутки |
  | Средний (требует внимания) | Генерация подробного отчета | Email + Telegram разработчику |
  | Высокий (критическая ситуация) | Активация режима экономии ресурсов | Email + Telegram + SMS администратору |

- **Интеллектуальные отчеты:**
  - **Ежедневный отчет ресурсов:**
    - Пики нагрузки и их причины
    - Самые ресурсоемкие запросы и пользователи
    - Рекомендации по оптимизации
    
  - **Еженедельный отчет производительности:**
    - Тренды использования ресурсов
    - Анализ времени отклика ИИ-сервиса
    - Прогноз на следующую неделю
    
  - **Отчеты по ошибкам:**
    - Группировка ошибок по типам и частоте
    - Корреляция с нагрузкой на систему
    - Автоматические предложения по исправлению

---

## 3. НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 3.1. Производительность
- **Временные характеристики:**
  | Операция | Максимальное время (P95) |
  |----------|-------------------------|
  | Аутентификация | 500 мс |
  | Загрузка чата | 1 сек |
  | Ответ ИИ-персонажа | 15 сек |
  | Сжатие контекста (20 сообщений) | 1.5 сек |
  | Синхронизация между устройствами | 3 сек |

- **Пропускная способность:**
  - Поддержка 100 одновременных WebSocket соединений
  - Обработка 50 запросов/сек на API endpoints
  - Максимальное время простоя при обрыве соединения с локальным ПК: 2 минуты

### 3.2. Безопасность
- **Сетевая безопасность:**
  - TLS 1.3 для всех соединений
  - Rate limiting для API и чата
  - Защита от DDoS через Nginx и fail2ban
  
- **Защита данных:**
  - Шифрование персональных данных в базе
  - Хеширование паролей с солью
  - Регулярные бэкапы базы данных
  
- **Соответствие законодательству:**
  - Политика конфиденциальности с акцентом на ИИ-генерируемый контент
  - Согласие пользователя на обработку данных
  - Механизм полного удаления аккаунта и данных

### 3.3. Доступность и отказоустойчивость
- **Сетевая архитектура:**
  - Основной канал: WebSocket over TLS
  - Резервный канал: Reverse SSH Tunnel
  - Self-hosted DDNS система для динамического IP
  - Автоматическое переключение каналов
  
- **Восстановление после сбоев:**
  - Автоматический перезапуск упавших сервисов
  - Резервное копирование конфигураций
  - Процедура ручного восстановления

### 3.4. Мобильная адаптация
- **Поддерживаемые устройства:**
  | Платформа | Версия | Поддержка функций |
  |-----------|--------|------------------|
  | iOS | 15+ | Полная |
  | Android | 11+ | Полная |
  | Windows | 10+ | Полная |
  | macOS | Monterey+ | Полная |
  
- **Требования к UX:**
  - Адаптивная верстка (mobile-first подход)
  - Поддержка темной темы
  - Оптимизация для медленных соединений
  - Offline-режим для просмотра истории

### 3.5. Требования к ИИ-модели мониторинга
- **Производительность:**
  | Метрика | Требование | Метод измерения |
  |---------|------------|----------------|
  | Время загрузки модели | ≤ 10 секунд | Среднее по 10 запускам |
  | Потребление памяти | ≤ 2 ГБ RAM | Мониторинг через Prometheus |
  | Пропускная способность | ≥ 100 анализов/сек | Нагрузочное тестирование |
  | Задержка прогноза | ≤ 1.5 сек на анализ часа данных | P95 на реальных данных |

- **Надежность:**
  - Автоматическое переключение на статистические методы при сбое модели
  - Резервное копирование весов модели каждые 6 часов
  - Самодиагностика качества прогнозов (ежедневная валидация)

- **Энергоэффективность:**
  - Минимальное потребление CPU во время простоя
  - Автоматическое понижение частоты анализа при низкой нагрузке
  - Оптимизация под работу на VDS без GPU

---

## 4. АРХИТЕКТУРА И ИНФРАСТРУКТУРА

### 4.1. Топология системы
```
[ VDS (chat.mehhost.ru) ] ←[Основной: WSS]→ [ Локальный ПК (ИИ-вычисления) ]
        ↑                               ↑
        └[Резервный: SSH Tunnel]────────┘

VDS компоненты (12 ГБ ОЗУ):
├── Nginx (reverse proxy, SSL termination, caching)
├── MySQL (InnoDB, основная база данных)
├── Python Backend (FastAPI/Uvicorn)
├── Redis (кеширование, очереди, сессии)
├── SMTP Server (Postfix для отправки email)
├── ИИ-модель мониторинга (PyTorch + ONNX Runtime)
└── Vue.js Frontend (статические файлы)

Локальный ПК:
├── WebSocket Server (FastAPI, прием задач)
├── ИИ-модели (Llama 3 8B, 4-bit quantized)
├── GPU Scheduler (PyTorch + CUDA 12.1)
└── Connection Manager (автоматическое восстановление)
```

### 4.2. Конфигурация оборудования

**VDS:**
- **Процессор:** 4 ядра
- **Память:** 12 ГБ RAM
- **Хранилище:** 100 ГБ SSD NVMe
- **Особенность:** Отсутствие дискретной видеокарты
- **Порты:** 443/tcp, 8443/tcp, 22/tcp, 25/tcp

**Локальный ПК:**
- **Процессор:** Intel i7-14700K
- **Видеокарта:** NVIDIA RTX 4070 (12 ГБ VRAM)
- **Память:** 32 ГБ DDR5 RAM
- **Хранилище:** 1 ТБ NVMe SSD

### 4.3. Технологический стек

**Фронтенд:**
- Vue.js 3 + TypeScript
- Vite.js 7
- Pinia (state management)
- Tailwind CSS + SCSS
- Chart.js (визуализация метрик)

**Бекенд (VDS):**
- Python 3.11 + FastAPI
- SQLAlchemy 2.0 + Alembic
- PyJWT + Passlib
- Redis-py + aioredis
- Celery + RabbitMQ
- PyTorch 2.1 + ONNX Runtime (модель мониторинга)
- TimescaleDB (временные ряды для метрик)

**ИИ-стек (локальный ПК):**
- PyTorch 2.1 + CUDA 12.1
- vLLM (высокопроизводительный инференс)
- Llama 3 8B (4-bit quantized)
- LangChain (управление контекстом)

**Инфраструктура:**
- Nginx 1.24
- MySQL 8.0
- Redis 7.0
- Prometheus + Grafana (мониторинг)
- Evidently AI (мониторинг качества моделей)
- UFW + fail2ban (безопасность)

### 4.4. Сетевое взаимодействие

**Основной канал (WebSocket over TLS):**
- **Протокол:** WSS (WebSocket Secure)
- **Порт:** 8443
- **Аутентификация:** API ключ в заголовке
- **Шифрование:** TLS 1.3

**Резервный канал (Reverse SSH Tunnel):**
- **Порт 2222:** Перенаправление на локальный ИИ-сервер
- **Автоматическое восстановление:** systemd timer
- **Безопасность:** Отдельный SSH пользователь

**DDNS система:**
- **Обновление IP:** каждые 5 минут
- **Хранение:** Redis на VDS с TTL 10 минут

### 4.5. Схема данных
```sql
-- Пользователи
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) DEFAULT 'user' CHECK (role IN ('user', 'manager', 'admin', 'moderator')),
    created_at TIMESTAMP DEFAULT NOW(),
    last_login TIMESTAMP,
    is_active BOOLEAN DEFAULT true,
    settings JSONB DEFAULT '{}'::jsonb
);

-- ИИ-персонажи
CREATE TABLE characters (
    id SERIAL PRIMARY KEY,
    uuid UUID UNIQUE DEFAULT gen_random_uuid() NOT NULL,
    name VARCHAR(50) NOT NULL UNIQUE,
    description TEXT CHECK (LENGTH(description) <= 500),
    system_prompt TEXT NOT NULL CHECK (LENGTH(system_prompt) <= 2000),
    temperature FLOAT DEFAULT 0.7 CHECK (temperature BETWEEN 0.0 AND 2.0),
    max_response_length INT DEFAULT 1500 CHECK (max_response_length BETWEEN 100 AND 2000),
    created_by INT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    uniqueness_hash VARCHAR(64) NOT NULL,
    CONSTRAINT unique_character_config UNIQUE (uniqueness_hash)
);

-- Сообщения
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL,
    character_id INT REFERENCES characters(id) NOT NULL,
    user_id INT REFERENCES users(id),
    content TEXT NOT NULL CHECK (LENGTH(content) <= 2000),
    role VARCHAR(10) CHECK (role IN ('user', 'assistant', 'system')),
    created_at TIMESTAMP DEFAULT NOW(),
    is_favorite BOOLEAN DEFAULT false,
    context_position INT CHECK (context_position BETWEEN 1 AND 20)
);

-- Мониторинг
CREATE TABLE system_metrics (
    id SERIAL PRIMARY KEY,
    source VARCHAR(20) CHECK (source IN ('vds', 'local_pc')),
    metric_type VARCHAR(20) NOT NULL,
    value FLOAT NOT NULL,
    max_value FLOAT NOT NULL,
    timestamp TIMESTAMP DEFAULT NOW()
);

-- Настройки уведомлений
CREATE TABLE notification_settings (
    id SERIAL PRIMARY KEY,
    developer_email VARCHAR(255) NOT NULL,
    is_confirmed BOOLEAN DEFAULT false,
    notification_level VARCHAR(20) DEFAULT 'critical',
    created_at TIMESTAMP DEFAULT NOW()
);

-- Метрики запросов
CREATE TABLE request_metrics (
    id SERIAL PRIMARY KEY,
    endpoint VARCHAR(100) NOT NULL,
    response_time FLOAT NOT NULL,
    status_code INT NOT NULL,
    user_id INT REFERENCES users(id),
    timestamp TIMESTAMP DEFAULT NOW(),
    resource_usage JSONB
);

-- Отчеты об ошибках
CREATE TABLE error_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    error_type VARCHAR(50) NOT NULL,
    error_message TEXT NOT NULL,
    stack_trace TEXT,
    frequency INT DEFAULT 1,
    first_occurrence TIMESTAMP DEFAULT NOW(),
    last_occurrence TIMESTAMP DEFAULT NOW(),
    resolved BOOLEAN DEFAULT false,
    correlation_data JSONB
);
```

### 4.6. Алгоритмы обработки

#### 4.6.1. Алгоритм управления контекстом
```
ПРИ ДОБАВЛЕНИИ НОВОГО СООБЩЕНИЯ:
1. Проверить длину сообщения (≤1000 для пользователя, ≤2000 для ИИ)
2. Если контекст содержит ≥20 сообщений:
   a. Выполнить анализ важности сообщений:
      - Сохранить первое и последнее сообщения
      - Сохранить сообщения с высоким эмоциональным содержанием
      - Сохранить сообщения, содержащие ключевые команды
   b. Удалить наименее важные сообщения до достижения 20
   c. Сгенерировать резюме удаленных сообщений
   d. Добавить резюме как системное сообщение
3. Добавить новое сообщение в контекст
4. Обновить порядковые номера позиций в контексте
```

#### 4.6.2. Алгоритм отображения статуса сервиса
```
ПРИ ЗАГРУЗКЕ ПРОФИЛЯ (АДМИН/МОДЕРАТОР):
1. Проверить роль пользователя:
   - Если администратор или модератор - продолжить
   - Иначе - не показывать виджет статуса
2. Получить актуальный статус ИИ-сервиса из кэша Redis:
   - Ключ: "ai_service_status"
   - Значение: "online", "offline", или "overloaded"
3. Определить цвет индикатора:
   - "online" → зеленый
   - "overloaded" → желтый  
   - "offline" → красный
4. Сгенерировать HTML виджет с динамическим обновлением
5. Настроить автоматическое обновление виджета каждые 15 секунд
```

#### 4.6.3. Алгоритм отправки уведомлений
```
ПРИ ПРЕВЫШЕНИИ ПОРОГА:
1. Проверить, не отправлялось ли уведомление об этом же алерте за последние 5 минут
2. Сформировать шаблон письма с детальной информацией
3. Отправить письмо через SMTP сервер VDS
4. Записать факт отправки в лог и базу данных
5. Если алерт критический и не подтвержден через 30 минут:
   a. Отправить дополнительное уведомление
```

#### 4.6.4. Алгоритм работы ИИ-модели мониторинга ресурсов
```
КАЖДЫЕ 5 МИНУТ:
1. Сбор данных мониторинга:
   - CPU/RAM/GPU utilization за последние 5 минут
   - Количество запросов к ИИ-сервису по типам
   - Время отклика и частота ошибок
   - Сетевая активность и пропускная способность

2. Предобработка данных:
   - Нормализация значений к диапазону [0, 1]
   - Удаление выбросов с использованием IQR метода
   - Создание скользящих средних (15 минут, 1 час)
   - Генерация производных признаков (скорость изменения, волатильность)

3. Выполнение анализа:
   - Загрузка модели из кэша (если не в памяти)
   - Прогнозирование нагрузки на следующие 30 минут
   - Обнаружение аномалий с использованием Z-score и изолирующих лесов
   - Расчет вероятности сбоя в ближайший час

4. Принятие решений:
   - Если прогнозируемая нагрузка > 90% от максимума:
     a. Отправить предупреждение разработчику
     b. Активировать режим экономии ресурсов (снижение max_response_length)
   
   - Если обнаружена аномалия с вероятностью > 0.85:
     a. Записать детальные логи для последующего анализа
     b. Сгенерировать отчет инцидента
     c. Отправить уведомление администратору

5. Генерация отчетов:
   - Ежедневная агрегация данных в 02:00 МСК
   - Формирование HTML/PDF отчета с графиками и рекомендациями
   - Отправка отчета по email разработчику и администратору
   - Сохранение отчета в архив системы (хранение 30 дней)
```

---

## 5. ПЛАН РЕАЛИЗАЦИИ

### 5.1. Этапы разработки

**Этап 1: Инфраструктура и ядро**
| Задача | Ответственный | Критерии приемки |
|--------|---------------|------------------|
| Настройка VDS (безопасность, Nginx, MySQL) | DevOps | UFW настроен, SSL работает, база создана |
| Система аутентификации (JWT, SMTP) | Backend | Регистрация/вход работают, email подтверждение |
| Базовый чат-интерфейс (фронтенд) | Frontend | Отправка/получение сообщений, WebSocket |
| Интеграция VDS ↔ Локальный ПК | DevOps/ML | Стабильное соединение, автоматическое восстановление |
| Настройка мониторинга ресурсов | DevOps | Метрики собираются с обоих серверов |

**Этап 2: Чат-функционал**
| Задача | Ответственный | Критерии приемки |
|--------|---------------|------------------|
| Управление контекстом (20 сообщений) | Backend/ML | Контекст сжимается корректно |
| Избранные сообщения | Fullstack | Пометка/просмотр избранных работает |
| Кросс-платформенная синхронизация | Backend | Сессии синхронизируются между устройствами |
| Ограничение длины сообщений | Fullstack | Обрезание работает, счетчик символов точный |

**Этап 3: Управление персонажами**
| Задача | Ответственный | Критерии приемки |
|--------|---------------|------------------|
| Визуальный редактор персонажей | Frontend | Все поля работают, валидация корректна |
| Уникальность персонажей | Backend | Проверка хешей и семантического сходства |
| Тестирование и предпросмотр | ML Engineer | Тестовые запросы работают |
| Версионирование конфигураций | Backend | История изменений, откат версий |

**Этап 3.5: Система ИИ-мониторинга ресурсов**
| Задача | Ответственный | Критерии приемки |
|--------|---------------|------------------|
| Разработка архитектуры легковесной модели для временных рядов | ML Engineer | Модель ≤ 400 МБ, MAE ≤ 8% на тестовых данных |
| Интеграция с Prometheus/Grafana | DevOps | Все метрики доступны в единой панели |
| Разработка алгоритмов детекции аномалий | ML Engineer/Backend | Обнаружение 95% искусственных аномалий в тестах |
| Система генерации интеллектуальных отчетов | Backend | Отчеты формируются автоматически в заданное время |
| Интеграция с каналами оповещения | Backend | Уведомления доставляются всем указанным способам |

**Этап 4: Администрирование и безопасность**
| Задача | Ответственный | Критерии приемки |
|--------|---------------|------------------|
| Админ-панель мониторинга | Frontend | Графики работают, алерты настраиваются |
| Система уведомлений через SMTP | Backend | Письма отправляются при превышении порогов |
| Статус сервиса в профилях | Frontend | Индикаторы отображаются корректно для разных ролей |
| Безопасность hardening | Security | Сканирование показывает < 5 medium уязвимостей |
| Финальное тестирование | QA | Все критерии приемки выполнены |

### 5.2. Ресурсы команды
| Роль | Количество | Обязанности |
|------|------------|-------------|
| Технический лидер | 1 | Архитектура, координация, code review |
| Backend разработчик | 2 | API, база данных, бизнес-логика |
| Frontend разработчик | 1 | Vue.js интерфейс, WebSocket интеграция |
| ML Engineer | 1 | ИИ-модели, инференс, оптимизация |
| DevOps инженер | 1 | Инфраструктура, развертывание, мониторинг |
| QA инженер | 1 | Тестирование, bug tracking, приемка |

---

## 6. ТЕСТИРОВАНИЕ

### 6.1. Стратегия тестирования
- **Unit-тесты:** покрытие ≥ 80% для backend, ≥ 70% для frontend
- **Интеграционные тесты:** все критические пути
- **E2E тесты:** Cypress для ключевых пользовательских сценариев
- **Нагрузочное тестирование:** k6/Locust для имитации 100 пользователей
- **Безопасность:** OWASP ZAP для поиска уязвимостей
- **Юзабилити:** реальные пользователи для оценки UX

### 6.2. Ключевые тест-кейсы

**Аутентификация:**
- Регистрация с валидным email → подтверждение отправлено
- Попытка входа с неверным паролем → ошибка после 3 попыток

**Чат-функционал:**
- Отправка сообщения длиной 1001 символ → обрезание до 1000
- Генерация ИИ-ответа длиной 2001 символ → обрезание до 2000 + "[...]"
- Отправка 21 сообщения → автоматическое сжатие до 20

**Мониторинг:**
- GPU загрузка ПК = 90% → круговой график показывает 90%, цвет красный
- Превышение CPU на ПК до 96% → отправка email разработчику
- Статус сервиса при отключении ПК → меняется на "офлайн" у админов/модераторов

**ИИ-модель мониторинга:**
- Имитация пиковой нагрузки (CPU 95% в течение 10 минут) → модель прогнозирует перегрузку за 15 минут до пика
- Генерация искусственной аномалии (DDoS-атака) → обнаружение с вероятностью ≥ 0.9
- Падение сервиса ИИ-модели → автоматическое переключение на статистические методы без потери мониторинга
- Обработка 1000 запросов/минуту → модель продолжает работать с задержкой ≤ 2 сек

**Отчетность:**
- Генерация ежедневного отчета в 02:00 → отчет создан, содержит все разделы, отправлен по email
- Имитация критической ошибки → создание отчета инцидента с рекомендациями в течение 5 минут
- Восстановление после сбоя → отчет содержит анализ причины и время простоя

**Управление персонажами:**
- Создание персонажа с именем "Ассистент" → успех
- Попытка создания второго персонажа с таким же системным промптом → ошибка

### 6.3. Метрики качества
| Метрика | Цель | Порог для блокировки релиза |
|---------|------|----------------------------|
| Покрытие unit-тестами | ≥ 75% | < 70% |
| Количество критических багов | 0 | > 0 |
| Время ответа API (P95) | ≤ 1 сек | > 2 сек |
| Уровень уязвимостей безопасности | 0 critical, ≤ 3 high | > 0 critical |

---

## 7. ДОКУМЕНТАЦИЯ И ПОДДЕРЖКА

### 7.1. Требуемая документация
- **Архитектурная документация:**
  - Диаграммы компонентов и взаимодействий
  - Описание сетевой топологии и точек отказа
  - Схемы баз данных с описанием полей
  
- **API документация:**
  - OpenAPI Specification 3.0 для всех endpoints
  - Примеры запросов и ответов
  - Описание error codes и их обработки
  
- **Runbook:**
  - Пошаговая инструкция развертывания
  - Процедуры восстановления при сбоях
  - Список зависимостей и их версий
  
- **Пользовательская документация:**
  - Руководство администратора
  - Инструкция для менеджеров по созданию персонажей
  - FAQ для конечных пользователей
  - Руководство по интерпретации отчетов мониторинга

### 7.2. Обучение пользователей
- **Интерактивные туториалы:**
  - Встроенное обучение при первом входе
  - Пошаговый гайд по созданию первого персонажа
  
- **Обучающие материалы:**
  - Видеоинструкции для администраторов
  - PDF руководства для всех ролей пользователей
  - Чек-листы для частых операций
  - Руководство по работе с системой отчетов

### 7.3. Поддержка после запуска
- **Уровень поддержки:**
  | Критичность | Время реакции | Время исправления |
  |-------------|--------------|------------------|
  | Критическая (падение сервиса) | 15 минут | 4 часа |
  | Высокая (ошибка в ключевой функции) | 1 час | 24 часа |
  | Средняя (баг в UI) | 4 часа | 72 часа |
  
- **Каналы поддержки:**
  - Telegram-чат для оперативного реагирования
  - Email для несрочных вопросов
  - Еженедельные созвоны для обсуждения улучшений

---

## 8. БЮДЖЕТ И РЕСУРСЫ

### 8.1. Финансовые ресурсы
| Статья расходов | Стоимость (руб) | Комментарии |
|----------------|----------------|-------------|
| Разработка | 1,850,000 | 462 часа работы (включая ИИ-модель мониторинга) |
| VDS хостинг | 15,000/мес | 12 ГБ ОЗУ |
| Резервное копирование | 3,000/мес | Внешний сервер |
| Инструменты разработки | 50,000 | Лицензии, облачные сервисы |
| Тестирование и аудит | 100,000 | Внешние специалисты |
| Дополнительные лицензии | 15,000 | Grafana Enterprise plugins |
| Обучение ML-модели | 80,000 | Вычислительные ресурсы и экспертиза |
| **Итого (старт)** | **2,113,000** |  |

### 8.2. Аппаратные ресурсы
| Компонент | Конфигурация |
|-----------|--------------|
| VDS сервер | 4 ядра, 12 ГБ ОЗУ, 100 ГБ SSD |
| Локальный ПК | i7-14700K, RTX 4070, 32 ГБ RAM |

### 8.3. Ограничения проекта
- **Технологические:** запрет на использование Docker и зарубежных CDN
- **Правовые:** полное соответствие законодательству РФ
- **Инфраструктурные:** отсутствие видеокарты на VDS
- **Ресурсные:** максимальный размер ИИ-модели мониторинга - 400 МБ

---

**Примечание:** Данное ТЗ фокусируется исключительно на техническом мониторинге ресурсов и анализе запросов с использованием легковесной предобученной ИИ-модели. Все аспекты контроля контента персонажей исключены в соответствии с принципом "все дозволено". Система предназначена для автоматизации процессов отслеживания ошибок, оптимизации производительности и прогнозирования нагрузки на инфраструктуру.

## 2.7. Система управления состоянием сервиса (выключение/включение)

### 2.7.1. Функционал принудительного выключения
- **Права доступа:**
  - **Администраторы:** Полный контроль над выключением сервиса
  - **Модераторы:** Право на инициирование выключения с подтверждением администратора
  - **Менеджеры и пользователи:** Просмотр статуса выключения, нет прав на управление
  
- **Типы выключения:**
  | Тип выключения | Описание | Время уведомления | Действия системы |
  |---------------|----------|-------------------|------------------|
  | Плановое | Запланированное техническое обслуживание | 24 часа | Грациозное завершение всех сессий |
  | Экстренное | Критическая ситуация (атака, сбой оборудования) | Немедленно | Принудительное завершение всех соединений |
  | Частичное | Отключение только ИИ-функционала с сохранением базового чата | 1 час | Отключение инференса, сохранение базовой функциональности |
  | Тестовое | Отключение на тестовом окружении | 15 минут | Имитация процесса без влияния на продакшн |

### 2.7.2. Процесс выключения сервиса
- **Этапы грациозного выключения:**
  1. **Уведомление пользователей:**
     - Отправка push-уведомлений всем активным пользователям
     - Отображение баннера в интерфейсе с обратным отсчетом
     - Email уведомления за 24/12/1 час до планового выключения
     
  2. **Подготовка к выключению:**
     - Блокировка создания новых сессий
     - Сохранение текущего состояния всех активных диалогов
     - Фиксация метрик системы перед выключением
     - Создание резервной копии базы данных в реальном времени
     
  3. **Завершение текущих операций:**
     - Завершение всех текущих генераций ИИ-ответов
     - Сохранение неотправленных сообщений в очередь восстановления
     - Отключение WebSocket соединений с подтверждением получения
     - Остановка фоновых задач и обработчиков

  4. **Финальное выключение:**
     - Остановка всех сервисов в порядке зависимости
     - Сохранение состояния системы в файл
     - Отключение сетевых интерфейсов
     - Фиксация времени и причины выключения в журнале безопасности

### 2.7.3. Восстановление после выключения
- **Автоматический рестарт:**
  - Мониторинг состояния сервисов каждые 30 секунд
  - Автоматический запуск в порядке зависимости при обнаружении остановки
  - Проверка целостности данных перед запуском основных сервисов
  - Восстановление сессий из сохраненного состояния

- **Ручное восстановление:**
  - Панель управления для администраторов с кнопками "Запустить сервис"
  - Пошаговый процесс восстановления с прогресс-баром
  - Возможность выборочного запуска компонентов
  - Ручная загрузка резервных копий при необходимости

### 2.7.4. Интерфейс управления выключением
- **Админ-панель управления:**
  - Виджет "Состояние сервиса" с индикаторами:
    - Зеленый: Сервис полностью доступен
    - Желтый: Плановое обслуживание (осталось X минут)
    - Красный: Сервис недоступен (выключен/ошибка)
    - Синий: Режим восстановления
  
  - Кнопки управления:
    - "Запланировать выключение" (календарь + время + причина)
    - "Экстренное выключение" (требует подтверждения)
    - "Отменить выключение" (доступна за 15+ минут до планового)
    - "Запустить сервис" (только при выключенном состоянии)
  
  - История операций:
    - Таблица всех операций выключения/включения
    - Фильтрация по дате, типу, администратору
    - Детали каждой операции (время, причина, продолжительность)
    - Статистика времени простоя

- **Пользовательский интерфейс при выключении:**
  - **За 24 часа:** Дискретное уведомление в настройках профиля
  - **За 1 час:** Постоянный баннер в шапке сайта
  - **За 15 минут:** Модальное окно с обратным отсчетом при каждом действии
  - **В процессе выключения:** Страница обслуживания с:
    - Таймером до восстановления
    - Причиной отключения
    - Контактами поддержки
    - Возможностью подписаться на уведомление о восстановлении

### 2.7.5. Система уведомлений о выключении
- **Каналы уведомлений:**
  | Роль | Push-уведомления | Email | SMS | Telegram |
  |------|------------------|-------|-----|----------|
  | Администратор | ✓ | ✓ | ✓ | ✓ |
  | Модератор | ✓ | ✓ | ✓ | ✓ |
  | Менеджер | ✓ | ✓ | ✗ | ✓ |
  | Пользователь | ✓ | ✓ | ✗ | ✗ |

- **Шаблоны уведомлений:**
  - **Плановое обслуживание (24 часа):**
    "Плановое техническое обслуживание сервиса chat.mehhost.ru запланировано на [дата] в [время] МСК. Сервис будет недоступен примерно на 30 минут. Все ваши диалоги будут сохранены."
  
  - **Экстренное выключение:**
    "ВНИМАНИЕ! Сервис chat.mehhost.ru временно недоступен из-за критической ситуации. Технические специалисты работают над восстановлением. Приносим извинения за неудобства."
  
  - **Восстановление сервиса:**
    "Сервис chat.mehhost.ru успешно восстановлен! Вы можете продолжить общение с ИИ-персонажами. Все ваши данные сохранены."

---

## 3. НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ (дополнение)

### 3.6. Требования к функционалу выключения
- **Надежность:**
  - Гарантия сохранения всех данных при плановом выключении
  - Максимальная потеря данных при экстренном выключении - 30 секунд активных сессий
  - Автоматическое восстановление после сбоя питания/сети в течение 5 минут
  
- **Безопасность:**
  - Двойная аутентификация для операций экстренного выключения
  - Аудит всех действий по выключению с привязкой к IP и устройству
  - Шифрование данных о причинах выключения в логах безопасности
  
- **Производительность:**
  | Тип выключения | Максимальное время завершения | Время восстановления |
  |---------------|-------------------------------|----------------------|
  | Плановое | 2 минуты | 3 минуты |
  | Экстренное | 30 секунд | 5 минут |
  | Частичное | 45 секунд | 1 минута |

- **Доступность:**
  - Страница обслуживания должна быть доступна даже при полной остановке сервиса
  - Минимальная конфигурация для отображения состояния должна работать на 10% ресурсов
  - Резервный канал для управления выключением при отказе основного

---

## 4. АРХИТЕКТУРА И ИНФРАСТРУКТУРА (дополнение)

### 4.6. Алгоритмы обработки (новый алгоритм)

#### 4.6.5. Алгоритм грациозного выключения сервиса
```
ПРИ ИНИЦИАЦИИ ВЫКЛЮЧЕНИЯ (АДМИНИСТРАТОРОМ):
1. Проверка прав доступа:
   - Верифицировать роль пользователя (только admin/moderator)
   - При экстренном выключении - запросить двойную аутентификацию
   - Записать операцию в аудит-лог с IP и timestamp

2. Определение типа выключения:
   - Если плановое и время > 15 минут:
     a. Сохранить конфигурацию выключения в базу
     b. Запустить таймер обратного отсчета
     c. Начать постепенное уведомление пользователей
   - Если экстренное или время ≤ 15 минут:
     a. Немедленно заблокировать новые подключения
     b. Отправить экстренные уведомления всем пользователям

3. Подготовка к выключению:
   - Установить флаг "maintenance_mode" в Redis
   - Сохранить состояние всех активных сессий:
     * Текущий контекст диалогов
     * Неотправленные сообщения
     * Позиции в истории
   - Создать точку восстановления базы данных
   - Зафиксировать метрики системы перед выключением

4. Грациозное завершение:
   - Отправить WebSocket сообщение "maintenance_start" всем клиентам
   - Дождаться подтверждения от 95% активных клиентов
   - Принудительно завершить оставшиеся соединения через 30 секунд
   - Остановить фоновые задачи в порядке:
     1. Celery workers
     2. WebSocket сервер
     3. FastAPI backend
     4. ИИ-модели на локальном ПК
     5. База данных (только чтение)

5. Финальные действия:
   - Активировать статическую страницу обслуживания
   - Отключить основные сервисы через systemd
   - Зафиксировать время и состояние выключения
   - Отправить уведомление администраторам об успешном выключении

ПРИ ВОССТАНОВЛЕНИИ:
1. Проверка готовности инфраструктуры
2. Запуск сервисов в порядке зависимости
3. Восстановление сессий из сохраненного состояния
4. Снятие флага "maintenance_mode"
5. Уведомление пользователей о восстановлении
```

---

## 5. ПЛАН РЕАЛИЗАЦИИ (дополнение)

### 5.1. Этапы разработки (новый этап)

**Этап 4.5: Система управления состоянием сервиса**
| Задача | Ответственный | Критерии приемки |
|--------|---------------|------------------|
| Разработка механизма грациозного выключения | Backend/DevOps | Все сессии сохраняются при плановом выключении |
| Создание админ-интерфейса управления | Frontend | Все кнопки работают, история отображается корректно |
| Система уведомлений о выключении | Backend | Уведомления доставляются всем каналам в заданное время |
| Страница обслуживания и восстановления | Frontend/DevOps | Страница доступна при полной остановке сервиса |
| Интеграция с системой мониторинга | DevOps/ML | Алерты о выключении интегрированы с ИИ-мониторингом |

---

## 6. ТЕСТИРОВАНИЕ (дополнение)

### 6.2. Ключевые тест-кейсы (новые)

**Тесты выключения сервиса:**
- Запуск планового выключения за 30 минут → все пользователи получают уведомления, новые подключения блокируются за 5 минут до окончания
- Экстренное выключение при 100 активных сессиях → 95% сессий сохранены, данные не повреждены
- Попытка выключения пользователем без прав → операция отклонена, запись в аудит-лог
- Восстановление после экстренного выключения → сервис полностью восстановлен за 4 минуты 30 секунд
- Сбой питания во время выключения → автоматическое восстановление при включении питания

**Тесты пользовательского опыта:**
- Пользователь в середине диалога при начале выключения → получает предупреждение и возможность завершить диалог
- Новая регистрация во время планового выключения → форма доступна, но с пометкой о скором обслуживании
- Доступ к истории чатов на странице обслуживания → базовые функции доступны в read-only режиме
- Восстановление после выключения → пользователь автоматически перенаправляется в последний активный диалог

---

## 7. ДОКУМЕНТАЦИЯ И ПОДДЕРЖКА (дополнение)

### 7.1. Требуемая документация (дополнение)
- **Runbook для выключения:**
  - Пошаговая инструкция планового выключения
  - Чек-лист для экстренного выключения
  - Процедура ручного восстановления при сбое автоматического
  - Контакты экстренной поддержки с приоритетами

- **Руководство администратора:**
  - Сценарии использования разных типов выключения
  - Диагностика проблем при восстановлении
  - Работа с резервными копиями при выключении
  - Анализ причин выключений через логи